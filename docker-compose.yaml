services:
  master-node:
    image: apache/hadoop:3
    platform: linux/amd64
    container_name: master-node
    hostname: master-node
    user: root
    command: ["bash", "-c", "mkdir -p /hadoop/dfs/name && chown -R hadoop:hadoop /hadoop && su hadoop -c 'if [ ! -d /hadoop/dfs/name/current ]; then hdfs namenode -format -force; fi && hdfs namenode'"]
    volumes:
      - ./hadoop_conf/core-site.xml:/opt/hadoop/etc/hadoop/core-site.xml
      - ./hadoop_conf/hdfs-site.xml:/opt/hadoop/etc/hadoop/hdfs-site.xml
      - master_node_data:/hadoop/dfs/name
    environment:
      HADOOP_HOME: /opt/hadoop
      ENSURE_NAMENODE_DIR: /hadoop/dfs/name
    ports:
      - "9870:9870"
      - "9000:9000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9870"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s

  slave-node-1:
    image: apache/hadoop:3
    platform: linux/amd64
    container_name: slave-node-1
    hostname: slave-node-1
    user: root
    command: ["bash", "-c", "mkdir -p /hadoop/dfs/data && chown -R hadoop:hadoop /hadoop && su hadoop -c 'hdfs datanode'"]
    volumes:
      - ./hadoop_conf/core-site.xml:/opt/hadoop/etc/hadoop/core-site.xml
      - ./hadoop_conf/hdfs-site.xml:/opt/hadoop/etc/hadoop/hdfs-site.xml
      - slave_node_1_data:/hadoop/dfs/data
    environment:
      HADOOP_HOME: /opt/hadoop
    depends_on:
      master-node:
        condition: service_healthy
    ports:
      - "9864:9864"

  slave-node-2:
    image: apache/hadoop:3
    platform: linux/amd64
    container_name: slave-node-2
    hostname: slave-node-2
    user: root
    command: ["bash", "-c", "mkdir -p /hadoop/dfs/data && chown -R hadoop:hadoop /hadoop && su hadoop -c 'hdfs datanode'"]
    volumes:
      - ./hadoop_conf/core-site.xml:/opt/hadoop/etc/hadoop/core-site.xml
      - ./hadoop_conf/hdfs-site.xml:/opt/hadoop/etc/hadoop/hdfs-site.xml
      - slave_node_2_data:/hadoop/dfs/data
    environment:
      HADOOP_HOME: /opt/hadoop
    depends_on:
      master-node:
        condition: service_healthy
    ports:
      - "9865:9864"

  hive-metastore-db:
    image: postgres:9.6-alpine
    container_name: hive-metastore-db
    environment:
      POSTGRES_DB: metastore
      POSTGRES_USER: hive
      POSTGRES_PASSWORD: hive
    volumes:
      - hive-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U hive -d metastore"]
      interval: 5s
      timeout: 5s
      retries: 5

  hive-metastore:
    image: bde2020/hive:2.3.2-postgresql-metastore
    platform: linux/amd64
    container_name: hive-metastore
    environment:
      SERVICE_PRECONDITION: "master-node:9870 hive-metastore-db:5432"
      HIVE_SITE_CONF_javax_jdo_option_ConnectionURL: "jdbc:postgresql://hive-metastore-db:5432/metastore"
      HIVE_SITE_CONF_javax_jdo_option_ConnectionDriverName: "org.postgresql.Driver"
      HIVE_SITE_CONF_javax_jdo_option_ConnectionUserName: "hive"
      HIVE_SITE_CONF_javax_jdo_option_ConnectionPassword: "hive"
      HIVE_SITE_CONF_datanucleus_autoCreateSchema: "true"
      HIVE_SITE_CONF_datanucleus_autoCreateTables: "true"
      HIVE_SITE_CONF_datanucleus_fixedDatastore: "false"
      HIVE_SITE_CONF_hive_metastore_schema_verification: "false"
      HIVE_SITE_CONF_hive_metastore_uris: "thrift://hive-metastore:9083"
    ports:
      - "9083:9083"
    volumes:
      - ./hadoop_conf/core-site.xml:/opt/hive/conf/core-site.xml
      - warehouse:/user/hive/warehouse
    depends_on:
      hive-metastore-db:
        condition: service_healthy
      master-node:
        condition: service_healthy
    command: /opt/hive/bin/hive --service metastore
    healthcheck:
      test: ["CMD", "bash", "-c", "cat < /dev/null > /dev/tcp/localhost/9083"]
      interval: 10s
      timeout: 10s
      retries: 15
      start_period: 120s

  hive-server:
    image: bde2020/hive:2.3.2-postgresql-metastore
    platform: linux/amd64
    container_name: hive-server
    environment:
      SERVICE_PRECONDITION: "hive-metastore:9083"
      HIVE_SITE_CONF_hive_metastore_uris: "thrift://hive-metastore:9083"
      HIVE_SITE_CONF_hive_server2_authentication: "NOSASL"
      HIVE_SITE_CONF_hive_server2_enable_doAs: "false"
    ports:
      - "10000:10000"
      - "10002:10002"
    volumes:
      - ./hadoop_conf/core-site.xml:/opt/hive/conf/core-site.xml
      - ./mbv_africa/data:/data
      - warehouse:/user/hive/warehouse
    depends_on:
      hive-metastore:
        condition: service_healthy
    command: /opt/hive/bin/hive --service hiveserver2
    healthcheck:
      test: ["CMD", "bash", "-c", "cat < /dev/null > /dev/tcp/localhost/10000"]
      interval: 30s
      timeout: 30s
      retries: 15
      start_period: 120s

  django-app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: django-app
    depends_on:
      hive-server:
        condition: service_started
    environment:
      HIVE_HOST: hive-server
      HIVE_PORT: 10000
      HIVE_DATABASE: mbv_africa
      HIVE_ENABLED: "true"
      PYTHONUNBUFFERED: 1
    ports:
      - "8080:8080"
    volumes:
      - ./mbv_africa:/Apache_Hive_Test_Application/mbv_africa
    restart: unless-stopped

volumes:
  master_node_data:
  slave_node_1_data:
  slave_node_2_data:
  hive-db-data:
  warehouse:
