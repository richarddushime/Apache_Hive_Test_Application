services:
  master-node:
    image: bde2020/hadoop-namenode:2.0.0-hadoop3.2.1-java8
    container_name: master-node
    volumes:
      - ./hadoop_conf/core-site.xml:/etc/hadoop/core-site.xml
      - ./hadoop_conf/hdfs-site.xml:/etc/hadoop/hdfs-site.xml
      - master_node_data:/hadoop/dfs/name
    environment:
      - CLUSTER_NAME=mbv-africa-cluster
    env_file:
      - ./hadoop.env
    ports:
      - "9870:9870"
      - "9000:9000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9870"]
      interval: 10s
      timeout: 5s
      retries: 5

  slave-node-1:
    image: bde2020/hadoop-datanode:2.0.0-hadoop3.2.1-java8
    container_name: slave-node-1
    volumes:
      - ./hadoop_conf/core-site.xml:/etc/hadoop/core-site.xml
      - ./hadoop_conf/hdfs-site.xml:/etc/hadoop/hdfs-site.xml
      - slave_node_1_data:/hadoop/dfs/data
    env_file:
      - ./hadoop.env
    environment:
      - SERVICE_PRECONDITION=master-node:9870
    depends_on:
      master-node:
        condition: service_healthy
    ports:
      - "9864:9864"

  slave-node-2:
    image: bde2020/hadoop-datanode:2.0.0-hadoop3.2.1-java8
    container_name: slave-node-2
    volumes:
      - ./hadoop_conf/core-site.xml:/etc/hadoop/core-site.xml
      - ./hadoop_conf/hdfs-site.xml:/etc/hadoop/hdfs-site.xml
      - slave_node_2_data:/hadoop/dfs/data
    env_file:
      - ./hadoop.env
    environment:
      - SERVICE_PRECONDITION=master-node:9870
    depends_on:
      master-node:
        condition: service_healthy
    ports:
      - "9865:9864"

  hive-metastore-db:
    image: postgres:9.6
    container_name: hive-metastore-db
    environment:
      POSTGRES_DB: metastore
      POSTGRES_USER: hive
      POSTGRES_PASSWORD: hive
    volumes:
      - hive-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U hive -d metastore"]
      interval: 5s
      timeout: 5s
      retries: 5

  hive-metastore:
    image: apache/hive:4.0.0
    container_name: hive-metastore
    environment:
      SERVICE_NAME: metastore
      DB_DRIVER: postgres
      SERVICE_OPTS: >-
        -Djavax.jdo.option.ConnectionDriverName=org.postgresql.Driver
        -Djavax.jdo.option.ConnectionURL=jdbc:postgresql://hive-metastore-db:5432/metastore
        -Djavax.jdo.option.ConnectionUserName=hive
        -Djavax.jdo.option.ConnectionPassword=hive
    ports:
      - "9083:9083"
    volumes:
      - ./hadoop_conf/core-site.xml:/opt/hadoop/etc/hadoop/core-site.xml
      - ./hadoop_conf/hdfs-site.xml:/opt/hadoop/etc/hadoop/hdfs-site.xml
      - ./hadoop_conf/hive-site.xml:/opt/hive/conf/hive-site.xml
      - ./jar/postgresql-42.7.2.jar:/opt/hive/lib/postgresql-jdbc.jar
      - warehouse:/user/hive/warehouse
    depends_on:
      hive-metastore-db:
        condition: service_healthy
      master-node:
        condition: service_healthy
    command: /opt/hive/bin/hive --service metastore
    healthcheck:
      test: ["CMD", "bash", "-c", "cat < /dev/null > /dev/tcp/localhost/9083"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 60s

  hive-server:
    image: apache/hive:4.0.0
    container_name: hive-server
    environment:
      SERVICE_NAME: hiveserver2
      HIVE_SERVER2_THRIFT_PORT: 10000
      IS_RESUME: "true"
    ports:
      - "10000:10000"
      - "10002:10002"
    volumes:
      - ./hadoop_conf/core-site.xml:/opt/hadoop/etc/hadoop/core-site.xml
      - ./hadoop_conf/hdfs-site.xml:/opt/hadoop/etc/hadoop/hdfs-site.xml
      - ./hadoop_conf/hive-site.xml:/opt/hive/conf/hive-site.xml
      - ./postgresql-42.7.2.jar:/opt/hive/lib/postgresql-jdbc.jar
      - ./mbv_africa/data:/data
      - warehouse:/user/hive/warehouse
    depends_on:
      hive-metastore:
        condition: service_healthy
    command: /opt/hive/bin/hive --service hiveserver2
    healthcheck:
      test: ["CMD", "bash", "-c", "cat < /dev/null > /dev/tcp/localhost/10000"]
      interval: 10s
      timeout: 10s
      retries: 15
      start_period: 90s

  django-app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: django-app
    depends_on:
      hive-server:
        condition: service_healthy
    environment:
      HIVE_HOST: hive-server
      HIVE_PORT: 10000
      HIVE_DATABASE: mbv_africa
      HIVE_ENABLED: "true"
      PYTHONUNBUFFERED: 1
    ports:
      - "8080:8080"
    volumes:
      - ./mbv_africa:/Apache_Hive_Test_Application/mbv_africa
    restart: unless-stopped

volumes:
  master_node_data:
  slave_node_1_data:
  slave_node_2_data:
  hive-db-data:
  warehouse:
