<!-- Data Source Indicator -->
<div style="margin-bottom: 1rem; padding: 0.5rem 1rem; background: rgba(16, 185, 129, 0.1); border-radius: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
    <span style="font-size: 0.875rem;">üìä</span>
    <span class="text-sm text-muted">Data from <strong>{{ stats.total_records }}</strong> observations across <strong>{{ stats.stations }}</strong> weather stations</span>
</div>

<!-- Temperature Anomalies Chart -->
<div class="card" style="margin-bottom: 1.5rem;">
    <div class="card-header">
        <h3 class="card-title">üå°Ô∏è Temperature Anomalies by Region (¬∞C deviation from baseline)</h3>
        <p class="card-description">Multi-year trend of regional temperature deviations ‚Äî data retrieved via HiveQL aggregation queries</p>
    </div>
    <div class="card-content">
        <div class="chart-container">
            <canvas id="temperatureChart"></canvas>
        </div>
        <details style="margin-top: 1rem;">
            <summary class="text-sm text-muted" style="cursor: pointer;">View Hive Query</summary>
            <pre style="margin-top: 0.5rem; font-size: 0.75rem;">SELECT region, year, 
       ROUND(AVG(temp_mean) - baseline, 2) as temp_anomaly
FROM africa_climate_observations o
JOIN climate_baselines b ON o.region = b.region
GROUP BY region, year
ORDER BY year;</pre>
        </details>
    </div>
</div>

<div class="grid grid-cols-2">
    <!-- Precipitation Comparison -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">üåßÔ∏è Regional Precipitation Analysis (mm/year)</h3>
            <p class="card-description">Observed vs ML-Predicted vs Historical Baseline</p>
        </div>
        <div class="card-content">
            <div class="chart-container-small">
                <canvas id="precipitationChart"></canvas>
            </div>
            <details style="margin-top: 1rem;">
                <summary class="text-sm text-muted" style="cursor: pointer;">View Hive Query</summary>
                <pre style="margin-top: 0.5rem; font-size: 0.75rem;">SELECT region, 
       SUM(precipitation) as total_precip,
       AVG(precipitation) * 12 as annual_avg
FROM africa_climate_observations
WHERE year = 2024
GROUP BY region;</pre>
            </details>
        </div>
    </div>

    <!-- Ocean Data -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">üåä Coastal Ocean Conditions</h3>
            <p class="card-description">Sea Surface Temperature & Salinity ‚Äî African coastlines</p>
        </div>
        <div class="card-content">
            <div class="chart-container-small">
                <canvas id="oceanChart"></canvas>
            </div>
            <details style="margin-top: 1rem;">
                <summary class="text-sm text-muted" style="cursor: pointer;">View Hive Query</summary>
                <pre style="margin-top: 0.5rem; font-size: 0.75rem;">SELECT month, 
       ROUND(AVG(sea_surface_temp), 1) as avg_sst,
       ROUND(AVG(ocean_salinity), 1) as avg_salinity
FROM africa_climate_observations
WHERE sea_surface_temp IS NOT NULL
GROUP BY month ORDER BY month;</pre>
            </details>
        </div>
    </div>
</div>

<!-- Key Insights - Dynamic -->
<div class="card" style="margin-top: 1.5rem;">
    <div class="card-header">
        <h3 class="card-title">üîç Climate Intelligence Insights</h3>
        <p class="card-description">Real-time analytics computed from Hive data warehouse queries</p>
    </div>
    <div class="card-content">
        <div class="grid grid-cols-4">
            <div class="insight-card insight-emerald">
                <p class="insight-value">{{ stats.total_records }}</p>
                <p class="insight-description">Total observations in data warehouse</p>
            </div>
            <div class="insight-card insight-blue">
                <p class="insight-value">{{ stats.regions }}</p>
                <p class="insight-description">African regions covered</p>
            </div>
            <div class="insight-card insight-amber">
                <p class="insight-value">{{ stats.date_range }}</p>
                <p class="insight-description">Temporal coverage range</p>
            </div>
            <div class="insight-card" style="background: rgba(139, 92, 246, 0.1); border-color: rgba(139, 92, 246, 0.3);">
                <p class="insight-value" style="color: #8b5cf6;">{{ stats.data_size }}</p>
                <p class="insight-description">Estimated data volume</p>
            </div>
        </div>
    </div>
</div>

<!-- Regional Breakdown Table -->
{% if regions %}
<div class="card" style="margin-top: 1.5rem;">
    <div class="card-header">
        <h3 class="card-title">üìç Regional Data Coverage</h3>
        <p class="card-description">Weather station distribution and observation counts by African region</p>
    </div>
    <div class="card-content">
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Region</th>
                        <th>Code</th>
                        <th style="text-align: right;">Stations</th>
                        <th style="text-align: right;">Observations</th>
                        <th>Coverage</th>
                    </tr>
                </thead>
                <tbody>
                    {% for region in regions %}
                    <tr>
                        <td class="font-medium">{{ region.name }}</td>
                        <td><span class="badge badge-outline font-mono">{{ region.code }}</span></td>
                        <td style="text-align: right;">{{ region.station_count }}</td>
                        <td style="text-align: right;">{{ region.observation_count }}</td>
                        <td>
                            <div style="background: #1e293b; border-radius: 9999px; height: 6px; width: 100px;">
                                <div style="background: #10b981; height: 100%; border-radius: 9999px; width: {% widthratio region.observation_count stats.observations_count 100 %}%;"></div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<script>
    function initializeTrendsCharts() {
        // Don't reinitialize if charts already exist
        if (window.trendsChartsInitialized) return;
        window.trendsChartsInitialized = true;

        // Temperature Trends Data
        const temperatureData = {{ temperature_trends| safe
    }};

    // Temperature Anomalies Chart
    const tempCtx = document.getElementById('temperatureChart');
    if (tempCtx) {
        new Chart(tempCtx, {
            type: 'line',
            data: {
                labels: temperatureData.map(d => d.year),
                datasets: [
                    {
                        label: 'East Africa',
                        data: temperatureData.map(d => d.east),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4
                    },
                    {
                        label: 'West Africa',
                        data: temperatureData.map(d => d.west),
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        tension: 0.4
                    },
                    {
                        label: 'North Africa',
                        data: temperatureData.map(d => d.north),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4
                    },
                    {
                        label: 'South Africa',
                        data: temperatureData.map(d => d.south),
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        tension: 0.4
                    },
                    {
                        label: 'Central Africa',
                        data: temperatureData.map(d => d.central),
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    // Precipitation Data
    const precipitationData = {{ precipitation_data| safe }};

    // Precipitation Chart
    const precipCtx = document.getElementById('precipitationChart');
    if (precipCtx) {
        new Chart(precipCtx, {
            type: 'bar',
            data: {
                labels: precipitationData.map(d => d.region),
                datasets: [
                    {
                        label: 'Actual 2024',
                        data: precipitationData.map(d => d.actual),
                        backgroundColor: '#10b981'
                    },
                    {
                        label: 'ML Predicted',
                        data: precipitationData.map(d => d.predicted),
                        backgroundColor: '#3b82f6'
                    },
                    {
                        label: '30-yr Baseline',
                        data: precipitationData.map(d => d.baseline),
                        backgroundColor: '#6b7280'
                    }
                ]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }

    // Ocean Data
    const oceanData = {{ ocean_data| safe }};

    // Ocean Chart
    const oceanCtx = document.getElementById('oceanChart');
    if (oceanCtx) {
        new Chart(oceanCtx, {
            type: 'line',
            data: {
                labels: oceanData.map(d => d.month),
                datasets: [
                    {
                        label: 'SST (¬∞C)',
                        data: oceanData.map(d => d.sst),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        yAxisID: 'y',
                        tension: 0.4
                    },
                    {
                        label: 'Salinity (PSU)',
                        data: oceanData.map(d => d.salinity),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        yAxisID: 'y1',
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left'
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        grid: {
                            drawOnChartArea: false
                        }
                    }
                }
            }
        });
    }
}

    // Initialize charts when tab becomes visible
    document.addEventListener('DOMContentLoaded', function () {
        // Observer to detect when trends tab is shown
        const observer = new MutationObserver(function (mutations) {
            mutations.forEach(function (mutation) {
                if (mutation.target.id === 'trends' && mutation.target.classList.contains('active')) {
                    setTimeout(initializeTrendsCharts, 100);
                }
            });
        });

        const trendsTab = document.getElementById('trends');
        if (trendsTab) {
            observer.observe(trendsTab, { attributes: true, attributeFilter: ['class'] });
        }
    });
</script>